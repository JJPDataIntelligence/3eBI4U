{% extends 'base.html' %}
{% load widget_tweaks %}
{% load i18n %}
{% load static %}

{% block head %}
    <title>BI4U - Locais de Serviço</title>
{% endblock head %}


{% block customcss %}
<style>

    .notsel {
        transform: translateY(50%);
        background-color: #000;
    }

    .sel {
        transform: translateY(50%);
        background-color: #B6F122;
    }

    [type="file"] {
        border: 0;
        clip: rect(0, 0, 0, 0);
        height: 1px;
        overflow: hidden;
        padding: 0;
        position: absolute !important;
        white-space: nowrap;
        width: 1px;
    }

    [type="file"] + label {

        border-radius: 4rem;
        color: #fff;
        cursor: pointer;
        display: inline-block;
        font-family: 'Poppins', sans-serif;
        font-size: 1rem;
        font-weight: 700;
        height: 4rem;
        line-height: 4rem;
        padding-left: 2rem;
        padding-right: 2rem;
        transition: background-color 0.3s;
    }

    [type="file"]:focus + label, [type="file"] + label:hover {
            background-color: #f15d22;
        }

    [type="file"]:focus + label {
            outline: 1px dotted #000;
            outline: -webkit-focus-ring-color auto 5px;
    }


</style>
{% endblock customcss %}

{% block content %}

    <div class="container" style = "border: solid 3px black; border-radius: 10px; padding: 40px; margin-top: 10px; margin-bottom: 40px;">
        
            <h2 class="page-header row row-no-gutter" style="margin-bottom: 40px">
                <span class="col-lg-6 pull-left hidden-xs">Locais de Serviço</span>
                <span class="text-nowrap hidden-sm hidden-md hidden-lg" style="font-size: 0.9em;">Locais de Serviço</span>
            </h2>

        <form action="" method="post" class = "form-horizontal col-lg-12" style="padding:0">
            {% csrf_token %}
            {{ formset.management_form }}


               <div class="row">   <!--ROW 1 STARTS-->

                {% for form in formset %}
                <div class="spacer"></div>

                <div class="row form-row" style="margin-bottom: 20px;">
                                        
                    <div class="row">
                        
                        {{form.id}}
                        <div class="col-sm-4 form-group">
                            <div class="col-sm-12">
                                <label class="col-sm-offset-1" for="{{form.nome.id_for_label}}">{{form.nome.label}}</label>
                                {% render_field form.nome class="form-control col-sm-offset-1 fmsetfield" placeholder="Nome" %}
                            </div>
                        </div>
                        <div class="col-sm-4 form-group">
                            <div class="col-sm-12">
                                <label class="col-sm-offset-1" for="{{form.funcionario_responsavel.id_for_label}}">{{form.funcionario_responsavel.label}}</label>
                                {% render_field form.funcionario_responsavel class="form-control col-sm-offset-1 fmsetfield" %}
                            </div>
                        </div>

                        <div class="col-sm-4 form-group">
                            <div class="col-sm-12">
                                <label class="col-sm-offset-1" for="{{form.CEP.id_for_label}}">{{form.CEP.label}}</label>
                                {% render_field form.CEP class="form-control col-sm-offset-1 cep js-cep fmsetfield" placeholder="00000-000" %}
                            </div>
                        </div>

                        <div class="col-sm-4 form-group">
                            <div class="col-sm-12">
                                    <label class="col-sm-offset-1" for="{{form.endereco.id_for_label}}">{{form.endereco.label}}</label>
                                {% render_field form.endereco class="form-control col-sm-offset-1 js-end fmsetfield" placeholder="Endereço" %}
                            </div>
                        </div>

                        <div class="col-sm-4 form-group">
                            <div class="col-sm-12">
                                <label class="col-sm-offset-1" for="{{form.numero.id_for_label}}">{{form.numero.label}}</label>
                                {% render_field form.numero class="form-control col-sm-offset-1 fmsetfield" placeholder="Número" %}
                            </div>
                        </div>
                        <div class="col-sm-4 form-group">
                            <div class="col-sm-12">
                                <label class="col-sm-offset-1" for="{{form.complemento.id_for_label}}">{{form.complemento.label}}</label>
                                {% render_field form.complemento class="form-control col-sm-offset-1 fmsetfield" placeholder="Complemento" %}
                            </div>
                        </div>
                        
                        <div class="col-sm-4 form-group">
                            <div class="col-sm-12">
                                <label class="col-sm-offset-1" for="{{form.bairro.id_for_label}}">{{form.bairro.label}}</label>
                                {% render_field form.bairro class="form-control col-sm-offset-1 js-bairro fmsetfield" placeholder="Bairro" %}
                            </div>
                        </div>
                        <div class="col-sm-4 form-group">
                            <div class="col-sm-12">
                                    <label class="col-sm-offset-1" for="{{form.municipio.id_for_label}}">{{form.municipio.label}}</label>
                                {% render_field form.municipio class="form-control col-sm-offset-1 js-municipio fmsetfield" placeholder="Município" %}
                            </div>
                        </div>

                        <div class="col-sm-4 form-group">
                            <div class="col-sm-12">
                                <label class="col-sm-offset-1" for="{{form.estado.id_for_label}}">{{form.estado.label}}</label>
                                {% render_field form.estado class="form-control col-sm-offset-1 js-estado fmsetfield" placeholder="Estado" %}
                            </div>
                        </div>
                    
                    </div>

                    <div class="btn-group pull-right col-sm-1">
                        <button class="btn btn-danger remove-form-row">-</button>
                        <button class="btn btn-success add-form-row">+</button>
                    </div>

                                            
                </div>
   
                {% endfor %}

            </div>
            <div class="spacer-md"></div>

            <div class="btn-group col-lg-offset-9 col-lg-3 col-xs-12">
                <button class="btn btn-success btn-md col-sm-6" onlick="window.location.replace('{% url base_return_url id=ID %}')" style="margin-top:10px; background: var(--darkblue); color:white; border-color: var(--darkblue);">Voltar</a>
                <button class="btn btn-success btn-md col-sm-6" type="submit" style="margin-top:10px; background: RGB(255, 163, 26); color:white; border-color: RGB(255, 163, 26);">Salvar</button>
            </div>
            
        </form>
    </div>

    <script>
        // DYNAMIC FORMSET AUXILIAR FUNCTIONS
        function updateElementIndex(el, prefix, ndx) {
                // UPDATES EACH ELEMENT INDEX
                var id_regex = new RegExp('(' + prefix + '-\\d+)');
                var replacement = prefix + '-' + ndx;
                if ($(el).attr("for")) $(el).attr("for", $(el).attr("for").replace(id_regex, replacement));
                if (el.id) el.id = el.id.replace(id_regex, replacement);
                if (el.name) el.name = el.name.replace(id_regex, replacement);
            };

        function cloneMore(selector, prefix) {
            // CLONES ORIGINAL ELEMENT WHEN ADDING NEW ONE AND CREATES REMOVE FORM BUTTON
            var newElement = $(selector).clone(true);
            var total = $('#id_' + prefix + '-TOTAL_FORMS').val();
            newElement.find(':input').each(function() {
                if ($(this).attr('name')){
                    var name = $(this).attr('name').replace('-' + (total-1) + '-', '-' + total + '-');
                    var id = 'id_' + name;
                    $(this).attr({'name': name, 'id': id}).val('').removeAttr('checked');
                }
            });
            
            total++;
            
            $('#id_' + prefix + '-TOTAL_FORMS').val(total);
            
            $(selector).after(newElement);
            
            //var conditionRow = $('.form-row:not(:last)');
            
            //conditionRow.find('.btn.add-form-row').removeClass('btn-success').addClass('btn-danger').removeClass('add-form-row').addClass('remove-form-row').html('-');
            
            return false;
        };

        function deleteForm(prefix, btn) {
            // CREATE DELETING FORM FUNCTIONALITY
            var total = parseInt($('#id_' + prefix + '-TOTAL_FORMS').val());
            if (total > 1){
                btn.closest('.form-row').remove();
                var forms = $('.form-row');
                $('#id_' + prefix + '-TOTAL_FORMS').val(forms.length);
                for (var i=0, formCount=forms.length; i<formCount; i++) {
                    $(forms.get(i)).find(':input').each(function() {
                        updateElementIndex(this, prefix, i);
                    });
                }
            }
            return false;
        };

        // ON LOADING PAGE (DOCUMENT.READY)
        $(document).ready(function(){

            // GETTING URL
            var id = window.location.href.match(/[1-9]+$/)[0];
            

            // ADDING FORM EVENT LISTENER TO CALL CLONEMORE
            $(document).on('click', '.add-form-row', function(e){
                e.preventDefault();
                cloneMore('.form-row:last', 'form');
            });

            // REMOVING FORM EVENT LISTENER TO CALL DELETEFORM
            $(document).on('click', '.remove-form-row', function(e){
                e.preventDefault();
                deleteForm('form', $(this));
                return false;
            });

            $('.cep').keydown(function(){
                
                var cep = $(this).val();
                cep = cep.replace(/\D/g,"")

                if ($(this).val().replace(/\D/g, "").length <= 9) {
				    cep = cep.replace(/(\d{5})(\d)/,"$1-$2")
                }
                
				
                $(this).val(cep);
            });

            $('.date').keydown(function(){
                var date = $(this).val();
                date = date.replace(/\D/g,"")
                date = date.replace(/(\d{2})(\d)/,"$1/$2")
				date = date.replace(/(\d)(\d{4})$/,"$1/$2")
				console.log();
                
                $(this).val(date);
            });
            


	    });

    </script>
{% endblock content %}
    
</body>